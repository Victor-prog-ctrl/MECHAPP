<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Mechapp · Inicio</title>
        <meta name="description" content="Servicio automotriz profesional." />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-sA+e2eT6Fv3YzZxbYlR5c+3F4iAfDdc0AG0eeYUIZ6A="
            crossorigin=""
        />
        <link rel="stylesheet" href="../Styles/paginainicio.css" />
    </head>
    <body>
        <header class="site-header">
            <div class="brand">
                <img src="../assets/logo.png" alt="Mechapp" class="brand-logo" />
                <span class="brand-name">Mechapp</span>
            </div>
            <nav class="main-nav" aria-label="Principal">
                <a href="#inicio" class="nav-link active">Inicio</a>
                <a href="#citas" class="nav-link">Citas</a>
                <a href="#mensajes" class="nav-link">Mensajes</a>
                <a href="#ubicacion" class="nav-link">Ubicación</a>
                <a href="./perfil.html" class="nav-link">Perfil</a>
                <a href="./registro-taller.html" class="nav-link" data-visible-for="mecanico" hidden>
                    Registrar Taller
                </a>
            </nav>
            <div class="header-actions">
                <a href="./login.html" class="button button-secondary" data-auth-visibility="unauthenticated">Iniciar sesión</a>
                <a href="#agendar" class="button button-primary">Agendar Cita</a>
                <a href="./perfil.html" class="button ghost">Mi Perfil</a>
                <a href="./registro-taller.html" class="button ghost" data-visible-for="mecanico" hidden>
                    Registrar Taller
                </a>
            </div>
        </header>

        <main>
            <section class="hero" id="inicio">
                <div class="hero-image" role="img" aria-label="Taller mecánico"></div>
                <div class="hero-content">
                    <span class="hero-tag">Tus Técnicos</span>
                    <h1>Confianza en Cada Reparación</h1>
                    <p>Tu Solución para el Mantenimiento Automotriz.</p>
                    <a class="button" href="./perfil.html">Ver Perfil</a>
                </div>
            </section>

            <section class="search-section" aria-labelledby="buscador">
                <div class="section-header">
                    <div>
                        <h2 id="buscador">Encuentra tu taller o servicio</h2>
                        <p>Escribe el nombre de un especialista o servicio y descubre más detalles.</p>
                    </div>
                </div>
                <div class="search-control">
                    <label class="visually-hidden" for="search-input">Buscar talleres o servicios</label>
                    <input
                        type="search"
                        id="search-input"
                        placeholder="Ej. frenos, eléctrico, mantenimiento"
                        autocomplete="off"
                    />
                </div>
                <div class="search-results" id="search-results" aria-live="polite"></div>
            </section>

            <section class="services" id="citas" aria-labelledby="servicios">
                <div class="section-header">
                    <div>
                        <h2 id="servicios">Servicios Populares</h2>
                        <p>Agenda los servicios más solicitados por nuestros clientes.</p>
                    </div>
                    <a class="button" href="#citas">Explorar</a>
                </div>
                <div class="grid">
                    <article class="service-card">
                        <div class="service-icon" aria-hidden="true"></div>
                        <div>
                            <h3>Mantenimiento General</h3>
                            <p>Incluye revisión completa de fluidos y ajustes básicos.</p>
                        </div>
                        <a class="button ghost" href="#">Próximas Citas</a>
                    </article>
                    <article class="service-card">
                        <div class="service-icon" aria-hidden="true"></div>
                        <div>
                            <h3>Diagnóstico Eléctrico</h3>
                            <p>Soluciones precisas para problemas eléctricos del vehículo.</p>
                        </div>
                        <a class="button ghost" href="#">Próximas Citas</a>
                    </article>
                    <article class="service-card">
                        <div class="service-icon" aria-hidden="true"></div>
                        <div>
                            <h3>Alineación y Balanceo</h3>
                            <p>Mejora el rendimiento y la seguridad en carretera.</p>
                        </div>
                        <a class="button ghost" href="#">Próximas Citas</a>
                    </article>
                </div>
            </section>

            <section class="location-section" id="ubicacion" aria-labelledby="geolocalizacion">
                <div class="section-header">
                    <div>
                        <h2 id="geolocalizacion">Busca el taller de tu comuna</h2>
                        <p>Utiliza el buscador o selecciona una comuna para explorar el mapa interactivo.</p>
                    </div>
                </div>
                <form class="comuna-form" id="comuna-form" novalidate>
                    <div class="form-field">
                        <label for="comuna-input">Nombre de la comuna</label>
                        <input
                            type="text"
                            id="comuna-input"
                            name="comuna"
                            placeholder="Ej. Santiago"
                            autocomplete="off"
                            aria-describedby="comuna-error"
                        />
                    </div>
                    <button class="button button-primary" type="submit" id="comuna-btn">Buscar comuna</button>
                    <div class="form-field">
                        <label for="comuna-select">Atajo de comunas</label>
                        <select id="comuna-select" name="comuna-select" aria-label="Seleccionar comuna rápidamente">
                            <option value="">Selecciona una comuna</option>
                        </select>
                    </div>
                </form>
                <p class="form-feedback" id="comuna-error" aria-live="polite"></p>
                <p class="location-status" id="location-status" aria-live="polite">
                    Mapa centrado en Santiago. Usa el buscador o el atajo para cambiar de comuna.
                </p>
                <div id="map" class="map-container" role="region" aria-label="Mapa interactivo de comunas"></div>
            </section>
        </main>

        <footer class="site-footer" id="mensajes">
            <div class="footer-column">
                <h4>Citas Directas</h4>
                <p>Atención personalizada para empresas y flotas.</p>
            </div>
            <div class="footer-column">
                <h4>Servicios Adicionales</h4>
                <ul>
                    <li>Mantenimiento Preventivo</li>
                    <li>Inspecciones Técnicas</li>
                    <li>Reemplazo de Partes</li>
                </ul>
            </div>
            <div class="footer-column">
                <h4>Contacto</h4>
                <p>+34 900 123 456</p>
                <p>soporte@autoserv.com</p>
            </div>
        </footer>
        <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-o9N1j6kPeE+YxBp2JgqS0hZ1uuQB3Lt1PPVPBJ3H+0o="
            crossorigin=""
        ></script>
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const searchInput = document.getElementById("search-input");
                const searchResults = document.getElementById("search-results");

                const mechanicOnlyElements = document.querySelectorAll('[data-visible-for="mecanico"]');
                const unauthenticatedOnlyElements = document.querySelectorAll('[data-auth-visibility="unauthenticated"]');

                const updateMechanicElementsVisibility = (shouldShow) => {
                    mechanicOnlyElements.forEach((element) => {
                        if (shouldShow) {
                            element.removeAttribute("hidden");
                        } else {
                            element.setAttribute("hidden", "");
                        }
                    });
                };

                const updateAuthVisibility = (isAuthenticated) => {
                    unauthenticatedOnlyElements.forEach((element) => {
                        if (isAuthenticated) {
                            element.setAttribute("hidden", "");
                        } else {
                            element.removeAttribute("hidden");
                        }
                    });
                };

                const verifyMechanicProfile = async () => {
                    try {
                        const response = await fetch("/api/profile");

                        if (!response.ok) {
                            if (response.status === 401) {
                                updateMechanicElementsVisibility(false);
                                updateAuthVisibility(false);
                                return;
                            }

                            throw new Error("No se pudo obtener el perfil del usuario");
                        }

                        const profile = await response.json();
                        updateMechanicElementsVisibility(profile?.accountType === "mecanico");
                        updateAuthVisibility(true);
                    } catch (error) {
                        console.error(error);
                        updateMechanicElementsVisibility(false);
                        updateAuthVisibility(false);
                    }
                };

                verifyMechanicProfile();

                const servicios = [
                    {
                        nombre: "Mantenimiento General",
                        descripcion: "Incluye revisión completa de fluidos y ajustes básicos.",
                        enlace: "#",
                        tipo: "Servicio"
                    },
                    {
                        nombre: "Diagnóstico Eléctrico",
                        descripcion: "Soluciones precisas para problemas eléctricos del vehículo.",
                        enlace: "#",
                        tipo: "Servicio"
                    },
                    {
                        nombre: "Alineación y Balanceo",
                        descripcion: "Mejora el rendimiento y la seguridad en carretera.",
                        enlace: "#",
                        tipo: "Servicio"
                    }
                ];

                const datosBusqueda = servicios;

                const renderResultados = (items) => {
                    if (!items.length) {
                        searchResults.innerHTML = '<p class="empty-results">No encontramos resultados que coincidan con tu búsqueda.</p>';
                        return;
                    }

                    const fragment = document.createDocumentFragment();

                    items.forEach((item) => {
                        const article = document.createElement("article");
                        article.className = "result-item";
                        article.innerHTML = `
                            <div class="result-type" aria-hidden="true">${item.tipo}</div>
                            <div class="result-content">
                                <h3>${item.nombre}</h3>
                                <p>${item.especialidad || item.descripcion}</p>
                            </div>
                            <a class="button ghost" href="${item.enlace}">Ver más</a>
                        `;
                        fragment.appendChild(article);
                    });

                    searchResults.innerHTML = "";
                    searchResults.appendChild(fragment);
                };

                renderResultados(datosBusqueda.slice(0, 3));

                searchInput.addEventListener("input", (event) => {
                    const termino = event.target.value.trim().toLowerCase();

                    if (!termino) {
                        renderResultados(datosBusqueda.slice(0, 3));
                        return;
                    }

                    const filtrados = datosBusqueda.filter((item) => {
                        const texto = `${item.nombre} ${item.especialidad || ""} ${item.descripcion || ""}`.toLowerCase();
                        return texto.includes(termino);
                    });

                    renderResultados(filtrados);
                });

                const initLocationSection = async () => {
                    const locationStatus = document.getElementById("location-status");
                    const mapContainer = document.getElementById("map");
                    const comunaForm = document.getElementById("comuna-form");
                    const comunaInput = document.getElementById("comuna-input");
                    const comunaSelect = document.getElementById("comuna-select");
                    const comunaSubmitButton = document.getElementById("comuna-btn");
                    const comunaError = document.getElementById("comuna-error");

                    if (
                        !locationStatus ||
                        !mapContainer ||
                        !comunaForm ||
                        !comunaInput ||
                        !comunaSelect ||
                        !comunaSubmitButton ||
                        !comunaError
                    ) {
                        return;
                    }

                    const MAP_DEFAULT = { lat: -33.45, lng: -70.66, zoom: 12, focusZoom: 13 };
                    const quickAccessComunas = [
                        "Santiago",
                        "Providencia",
                        "Ñuñoa",
                        "Las Condes",
                        "Vitacura",
                        "Lo Barnechea",
                        "Maipú",
                        "Puente Alto",
                        "La Florida",
                        "San Bernardo",
                        "Peñalolén",
                        "La Reina",
                        "Independencia",
                        "Recoleta",
                        "Estación Central",
                        "Quilicura",
                        "La Cisterna",
                        "La Pintana"
                    ];
                    const fallbackComunas = [
                        { nombre: "Santiago", lat: -33.45, lng: -70.66 },
                        { nombre: "Providencia", lat: -33.42628, lng: -70.60974 },
                        { nombre: "Ñuñoa", lat: -33.45694, lng: -70.59501 },
                        { nombre: "Las Condes", lat: -33.40835, lng: -70.56796 },
                        { nombre: "Vitacura", lat: -33.39971, lng: -70.60248 },
                        { nombre: "Lo Barnechea", lat: -33.35694, lng: -70.50528 },
                        { nombre: "Maipú", lat: -33.51645, lng: -70.76663 },
                        { nombre: "Puente Alto", lat: -33.6111, lng: -70.5758 },
                        { nombre: "La Florida", lat: -33.52192, lng: -70.60571 },
                        { nombre: "San Bernardo", lat: -33.59217, lng: -70.6996 },
                        { nombre: "Peñalolén", lat: -33.48235, lng: -70.54354 },
                        { nombre: "La Reina", lat: -33.44128, lng: -70.54999 },
                        { nombre: "Independencia", lat: -33.41989, lng: -70.65406 },
                        { nombre: "Recoleta", lat: -33.41529, lng: -70.64157 },
                        { nombre: "Estación Central", lat: -33.45152, lng: -70.6883 },
                        { nombre: "Quilicura", lat: -33.35739, lng: -70.7365 },
                        { nombre: "La Cisterna", lat: -33.54321, lng: -70.66046 },
                        { nombre: "La Pintana", lat: -33.5838, lng: -70.6265 }
                    ];

                    let comunasData = [];
                    let comunasIndex = new Map();
                    let mapInstance;
                    let comunaMarker;

                    const normalizeText = (text = "") =>
                        text
                            .toString()
                            .trim()
                            .toLowerCase()
                            .normalize("NFD")
                            .replace(/[\u0300-\u036f]/g, "")
                            .replace(/ñ/g, "n");

                    const disableControls = () => {
                        comunaInput.disabled = true;
                        comunaSelect.disabled = true;
                        comunaSubmitButton.disabled = true;
                    };

                    const buildIndex = (comunas) => {
                        comunasIndex = new Map();
                        comunas.forEach((comuna) => {
                            const key = normalizeText(comuna.nombre);
                            if (!comunasIndex.has(key)) {
                                comunasIndex.set(key, comuna);
                            }
                        });
                    };

                    const populateSelect = (comunas) => {
                        while (comunaSelect.options.length > 1) {
                            comunaSelect.remove(1);
                        }

                        const comunasByName = new Map();
                        comunas.forEach((comuna) => {
                            comunasByName.set(comuna.nombre, comuna);
                        });

                        const fragment = document.createDocumentFragment();

                        quickAccessComunas.forEach((nombre) => {
                            if (!comunasByName.has(nombre)) {
                                return;
                            }

                            const option = document.createElement("option");
                            option.value = nombre;
                            option.textContent = nombre;
                            fragment.appendChild(option);
                            comunasByName.delete(nombre);
                        });

                        if (comunasByName.size) {
                            const optgroup = document.createElement("optgroup");
                            optgroup.label = "Otras comunas";

                            Array.from(comunasByName.keys())
                                .sort((a, b) => a.localeCompare(b, "es"))
                                .forEach((nombre) => {
                                    const option = document.createElement("option");
                                    option.value = nombre;
                                    option.textContent = nombre;
                                    optgroup.appendChild(option);
                                });

                            fragment.appendChild(optgroup);
                        }

                        comunaSelect.appendChild(fragment);
                    };

                    const ensureMap = () => {
                        if (mapInstance) {
                            return mapInstance;
                        }

                        if (!window.L) {
                            locationStatus.textContent =
                                "No fue posible cargar el mapa interactivo. Intenta nuevamente más tarde.";
                            disableControls();
                            return null;
                        }

                        mapInstance = L.map(mapContainer).setView(
                            [MAP_DEFAULT.lat, MAP_DEFAULT.lng],
                            MAP_DEFAULT.zoom
                        );

                        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                            attribution:
                                '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            maxZoom: 19
                        }).addTo(mapInstance);

                        mapContainer.setAttribute("tabindex", "0");

                        comunaMarker = L.marker([MAP_DEFAULT.lat, MAP_DEFAULT.lng]).addTo(mapInstance);
                        comunaMarker.bindPopup("Comuna: Santiago").openPopup();

                        return mapInstance;
                    };

                    const focusComuna = (comuna, { openPopup = true, useDefaultZoom = false } = {}) => {
                        const map = ensureMap();
                        if (!map || !comuna) {
                            return;
                        }

                        const position = [comuna.lat, comuna.lng];
                        const zoomLevel = useDefaultZoom ? MAP_DEFAULT.zoom : MAP_DEFAULT.focusZoom;

                        map.setView(position, zoomLevel);

                        if (!comunaMarker) {
                            comunaMarker = L.marker(position).addTo(map);
                        } else {
                            comunaMarker.setLatLng(position);
                        }

                        comunaMarker.bindPopup(`Comuna: ${comuna.nombre}`);

                        if (openPopup) {
                            comunaMarker.openPopup();
                        }

                        locationStatus.textContent = `Mostrando comuna: ${comuna.nombre}.`;
                        comunaError.textContent = "";
                        comunaInput.value = comuna.nombre;
                        comunaSelect.value = comuna.nombre;
                    };

                    const findComuna = (query) => {
                        const normalizedQuery = normalizeText(query);
                        if (!normalizedQuery) {
                            return null;
                        }

                        if (comunasIndex.has(normalizedQuery)) {
                            return comunasIndex.get(normalizedQuery);
                        }

                        for (const [key, comuna] of comunasIndex.entries()) {
                            if (key.startsWith(normalizedQuery)) {
                                return comuna;
                            }
                        }

                        return null;
                    };

                    const loadComunas = async () => {
                        try {
                            const response = await fetch("/data/comunas_cl.json");

                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}`);
                            }

                            const data = await response.json();

                            if (!Array.isArray(data) || !data.length) {
                                throw new Error("Listado de comunas no válido");
                            }

                            return data;
                        } catch (error) {
                            console.error("No se pudo cargar el listado de comunas.", error);
                            return fallbackComunas;
                        }
                    };

                    comunasData = await loadComunas();

                    if (!comunasData.length) {
                        locationStatus.textContent =
                            "No hay comunas disponibles para mostrar en el mapa.";
                        disableControls();
                        return;
                    }

                    buildIndex(comunasData);
                    populateSelect(comunasData);

                    const defaultComuna = findComuna("Santiago") || comunasData[0];

                    if (defaultComuna) {
                        focusComuna(defaultComuna, { openPopup: true, useDefaultZoom: true });
                    }

                    comunaForm.addEventListener("submit", (event) => {
                        event.preventDefault();

                        const rawValue = comunaInput.value.trim();
                        if (!rawValue) {
                            comunaError.textContent = "Ingresa el nombre de una comuna.";
                            locationStatus.textContent =
                                "Ingresa una comuna para actualizar el mapa.";
                            comunaInput.focus();
                            return;
                        }

                        const comuna = findComuna(rawValue);

                        if (!comuna) {
                            comunaError.textContent =
                                "No encontramos la comuna ingresada. Intenta con otro nombre.";
                            locationStatus.textContent =
                                "No encontramos la comuna ingresada. Revisa el nombre e inténtalo nuevamente.";
                            comunaSelect.value = "";
                            return;
                        }

                        focusComuna(comuna, { openPopup: true });
                        comunaInput.blur();
                    });

                    comunaSelect.addEventListener("change", (event) => {
                        const value = event.target.value;

                        if (!value) {
                            comunaError.textContent = "";
                            return;
                        }

                        const comuna = findComuna(value);

                        if (!comuna) {
                            comunaError.textContent = "No encontramos la comuna seleccionada.";
                            locationStatus.textContent =
                                "No encontramos la comuna seleccionada. Elige otra opción.";
                            return;
                        }

                        comunaInput.value = comuna.nombre;
                        focusComuna(comuna, { openPopup: true });
                    });

                    comunaInput.addEventListener("input", (event) => {
                        if (event.target.value.trim()) {
                            comunaError.textContent = "";
                            return;
                        }

                        comunaError.textContent = "";
                        locationStatus.textContent =
                            "Mapa centrado en Santiago. Usa el buscador o el atajo para cambiar de comuna.";
                    });
                };

                initLocationSection();
            });
        </script>
    </body>
</html>
