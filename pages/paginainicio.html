<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Mechapp · Inicio</title>
        <meta name="description" content="Servicio automotriz profesional." />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="../Styles/paginainicio.css" />
    </head>
    <body>
        <header class="site-header">
            <div class="brand">
                <img src="../assets/logo.png" alt="Mechapp" class="brand-logo" />
                <span class="brand-name">Mechapp</span>
            </div>
            <nav class="main-nav" aria-label="Principal">
                <a href="#inicio" class="nav-link active">Inicio</a>
                <a href="#citas" class="nav-link">Citas</a>
                <a href="#mensajes" class="nav-link">Mensajes</a>
                <a href="#ubicacion" class="nav-link">Ubicación</a>
                <a href="./perfil.html" class="nav-link">Perfil</a>
                <a href="./registro-taller.html" class="nav-link" data-visible-for="mecanico" hidden>
                    Registrar Taller
                </a>
            </nav>
            <div class="header-actions">
                <a href="./login.html" class="button button-secondary" data-auth-visibility="unauthenticated">Iniciar sesión</a>
                <a href="#agendar" class="button button-primary">Agendar Cita</a>
                <a href="./perfil.html" class="button ghost">Mi Perfil</a>
                <a href="./registro-taller.html" class="button ghost" data-visible-for="mecanico" hidden>
                    Registrar Taller
                </a>
            </div>
        </header>

        <main>
            <section class="hero" id="inicio">
                <div class="hero-image" role="img" aria-label="Taller mecánico"></div>
                <div class="hero-content">
                    <span class="hero-tag">Tus Técnicos</span>
                    <h1>Confianza en Cada Reparación</h1>
                    <p>Tu Solución para el Mantenimiento Automotriz.</p>
                    <a class="button" href="./perfil.html">Ver Perfil</a>
                </div>
            </section>

            <section class="search-section" aria-labelledby="buscador">
                <div class="section-header">
                    <div>
                        <h2 id="buscador">Encuentra tu taller o servicio</h2>
                        <p>Escribe el nombre de un especialista o servicio y descubre más detalles.</p>
                    </div>
                </div>
                <div class="search-control">
                    <label class="visually-hidden" for="search-input">Buscar talleres o servicios</label>
                    <input
                        type="search"
                        id="search-input"
                        placeholder="Ej. frenos, eléctrico, mantenimiento"
                        autocomplete="off"
                    />
                </div>
                <div class="search-results" id="search-results" aria-live="polite"></div>
            </section>

            <section class="services" id="citas" aria-labelledby="servicios">
                <div class="section-header">
                    <div>
                        <h2 id="servicios">Servicios Populares</h2>
                        <p>Agenda los servicios más solicitados por nuestros clientes.</p>
                    </div>
                    <a class="button" href="#citas">Explorar</a>
                </div>
                <div class="grid">
                    <article class="service-card">
                        <div class="service-icon" aria-hidden="true"></div>
                        <div>
                            <h3>Mantenimiento General</h3>
                            <p>Incluye revisión completa de fluidos y ajustes básicos.</p>
                        </div>
                        <a class="button ghost" href="#">Próximas Citas</a>
                    </article>
                    <article class="service-card">
                        <div class="service-icon" aria-hidden="true"></div>
                        <div>
                            <h3>Diagnóstico Eléctrico</h3>
                            <p>Soluciones precisas para problemas eléctricos del vehículo.</p>
                        </div>
                        <a class="button ghost" href="#">Próximas Citas</a>
                    </article>
                    <article class="service-card">
                        <div class="service-icon" aria-hidden="true"></div>
                        <div>
                            <h3>Alineación y Balanceo</h3>
                            <p>Mejora el rendimiento y la seguridad en carretera.</p>
                        </div>
                        <a class="button ghost" href="#">Próximas Citas</a>
                    </article>
                </div>
            </section>

            <section class="location-section" id="ubicacion" aria-labelledby="geolocalizacion">
                <div class="section-header">
                    <div>
                        <h2 id="geolocalizacion">Talleres por comuna</h2>
                        <p>Escribe el nombre de una comuna para explorar los talleres disponibles en esa zona.</p>
                    </div>
                    <form class="comuna-form" id="comuna-form">
                        <label class="visually-hidden" for="comuna-input">Buscar talleres por comuna</label>
                        <input
                            type="text"
                            id="comuna-input"
                            name="comuna"
                            placeholder="Ej. Santiago"
                            list="comunas-sugeridas"
                            autocomplete="off"
                            required
                        />
                        <datalist id="comunas-sugeridas"></datalist>
                        <button class="button ghost" type="submit" id="comuna-btn">Buscar comuna</button>
                    </form>
                </div>
                <p class="location-status" id="location-status" aria-live="polite">
                    Ingresa una comuna para ver los talleres disponibles en el mapa.
                </p>
                <div id="map" class="map-container" role="region" aria-label="Mapa de talleres cercanos"></div>
            </section>
        </main>

        <footer class="site-footer" id="mensajes">
            <div class="footer-column">
                <h4>Citas Directas</h4>
                <p>Atención personalizada para empresas y flotas.</p>
            </div>
            <div class="footer-column">
                <h4>Servicios Adicionales</h4>
                <ul>
                    <li>Mantenimiento Preventivo</li>
                    <li>Inspecciones Técnicas</li>
                    <li>Reemplazo de Partes</li>
                </ul>
            </div>
            <div class="footer-column">
                <h4>Contacto</h4>
                <p>+34 900 123 456</p>
                <p>soporte@autoserv.com</p>
            </div>
        </footer>
        <script>
            let inicializarMapaGoogle;

            window.initMap = () => {
                if (typeof inicializarMapaGoogle === "function") {
                    inicializarMapaGoogle();
                }
            };

            document.addEventListener("DOMContentLoaded", () => {
                const searchInput = document.getElementById("search-input");
                const searchResults = document.getElementById("search-results");

                const mechanicOnlyElements = document.querySelectorAll('[data-visible-for="mecanico"]');
                const unauthenticatedOnlyElements = document.querySelectorAll('[data-auth-visibility="unauthenticated"]');

                const updateMechanicElementsVisibility = (shouldShow) => {
                    mechanicOnlyElements.forEach((element) => {
                        if (shouldShow) {
                            element.removeAttribute("hidden");
                        } else {
                            element.setAttribute("hidden", "");
                        }
                    });
                };

                const updateAuthVisibility = (isAuthenticated) => {
                    unauthenticatedOnlyElements.forEach((element) => {
                        if (isAuthenticated) {
                            element.setAttribute("hidden", "");
                        } else {
                            element.removeAttribute("hidden");
                        }
                    });
                };

                const verifyMechanicProfile = async () => {
                    try {
                        const response = await fetch("/api/profile");

                        if (!response.ok) {
                            if (response.status === 401) {
                                updateMechanicElementsVisibility(false);
                                updateAuthVisibility(false);
                                return;
                            }

                            throw new Error("No se pudo obtener el perfil del usuario");
                        }

                        const profile = await response.json();
                        updateMechanicElementsVisibility(profile?.accountType === "mecanico");
                        updateAuthVisibility(true);
                    } catch (error) {
                        console.error(error);
                        updateMechanicElementsVisibility(false);
                        updateAuthVisibility(false);
                    }
                };

                verifyMechanicProfile();

                const servicios = [
                    {
                        nombre: "Mantenimiento General",
                        descripcion: "Incluye revisión completa de fluidos y ajustes básicos.",
                        enlace: "#",
                        tipo: "Servicio"
                    },
                    {
                        nombre: "Diagnóstico Eléctrico",
                        descripcion: "Soluciones precisas para problemas eléctricos del vehículo.",
                        enlace: "#",
                        tipo: "Servicio"
                    },
                    {
                        nombre: "Alineación y Balanceo",
                        descripcion: "Mejora el rendimiento y la seguridad en carretera.",
                        enlace: "#",
                        tipo: "Servicio"
                    }
                ];

                const datosBusqueda = servicios;

                const renderResultados = (items) => {
                    if (!items.length) {
                        searchResults.innerHTML = '<p class="empty-results">No encontramos resultados que coincidan con tu búsqueda.</p>';
                        return;
                    }

                    const fragment = document.createDocumentFragment();

                    items.forEach((item) => {
                        const article = document.createElement("article");
                        article.className = "result-item";
                        article.innerHTML = `
                            <div class="result-type" aria-hidden="true">${item.tipo}</div>
                            <div class="result-content">
                                <h3>${item.nombre}</h3>
                                <p>${item.especialidad || item.descripcion}</p>
                            </div>
                            <a class="button ghost" href="${item.enlace}">Ver más</a>
                        `;
                        fragment.appendChild(article);
                    });

                    searchResults.innerHTML = "";
                    searchResults.appendChild(fragment);
                };

                renderResultados(datosBusqueda.slice(0, 3));

                searchInput.addEventListener("input", (event) => {
                    const termino = event.target.value.trim().toLowerCase();

                    if (!termino) {
                        renderResultados(datosBusqueda.slice(0, 3));
                        return;
                    }

                    const filtrados = datosBusqueda.filter((item) => {
                        const texto = `${item.nombre} ${item.especialidad || ""} ${item.descripcion || ""}`.toLowerCase();
                        return texto.includes(termino);
                    });

                    renderResultados(filtrados);
                });

                const locationStatus = document.getElementById("location-status");
                const mapContainer = document.getElementById("map");
                const comunaForm = document.getElementById("comuna-form");
                const comunaInput = document.getElementById("comuna-input");
                const comunasSugeridas = document.getElementById("comunas-sugeridas");

                const talleresPorComuna = [
                    {
                        nombre: "Taller MotorPlus",
                        comuna: "Santiago",
                        direccion: "Av. Libertador Bernardo O'Higgins 1345",
                        lat: -33.4475,
                        lng: -70.6736
                    },
                    {
                        nombre: "Servicio Integral Centro",
                        comuna: "Santiago",
                        direccion: "San Diego 245",
                        lat: -33.4558,
                        lng: -70.6483
                    },
                    {
                        nombre: "AutoFix Providencia",
                        comuna: "Providencia",
                        direccion: "Av. Providencia 1650",
                        lat: -33.4258,
                        lng: -70.6095
                    },
                    {
                        nombre: "Mecánica Los Leones",
                        comuna: "Providencia",
                        direccion: "Los Leones 123",
                        lat: -33.4212,
                        lng: -70.6104
                    },
                    {
                        nombre: "Garage Ñuñoa",
                        comuna: "Ñuñoa",
                        direccion: "Av. Irarrázaval 2890",
                        lat: -33.4532,
                        lng: -70.5986
                    },
                    {
                        nombre: "ElectroCar Ñuñoa",
                        comuna: "Ñuñoa",
                        direccion: "José Domingo Cañas 1801",
                        lat: -33.4615,
                        lng: -70.6009
                    },
                    {
                        nombre: "Taller Viña Autos",
                        comuna: "Viña del Mar",
                        direccion: "Av. Libertad 749",
                        lat: -33.0245,
                        lng: -71.5528
                    },
                    {
                        nombre: "Servicio Marga Marga",
                        comuna: "Viña del Mar",
                        direccion: "Quillota 45",
                        lat: -33.0351,
                        lng: -71.5925
                    },
                    {
                        nombre: "Puerto Motor",
                        comuna: "Valparaíso",
                        direccion: "Av. Argentina 1230",
                        lat: -33.0472,
                        lng: -71.6127
                    },
                    {
                        nombre: "Mecánica Barón",
                        comuna: "Valparaíso",
                        direccion: "Av. España 2350",
                        lat: -33.0468,
                        lng: -71.6123
                    }
                ];

                const normalizarTexto = (texto) =>
                    texto
                        .normalize("NFD")
                        .replace(/[\u0300-\u036f]/g, "")
                        .toLowerCase();

                const comunasDisponibles = Array.from(
                    new Set(talleresPorComuna.map((taller) => taller.comuna))
                ).sort((a, b) => a.localeCompare(b, "es"));

                comunasDisponibles.forEach((comuna) => {
                    const option = document.createElement("option");
                    option.value = comuna;
                    comunasSugeridas.appendChild(option);
                });

                const DEFAULT_CENTER = { lat: -33.45, lng: -70.66 };
                const DEFAULT_ZOOM = 11;
                let mapa;
                let marcadores = [];

                inicializarMapaGoogle = () => {
                    mapa = new google.maps.Map(mapContainer, {
                        center: DEFAULT_CENTER,
                        zoom: DEFAULT_ZOOM,
                        mapTypeControl: false,
                        streetViewControl: false,
                        fullscreenControl: false
                    });
                };

                const obtenerMapa = () => {
                    if (!window.google || !google.maps) {
                        locationStatus.textContent =
                            "El mapa de Google no se pudo cargar. Verifica tu conexión o la clave de API.";
                        return null;
                    }

                    if (!mapa) {
                        window.initMap();
                    }

                    return mapa;
                };

                const mostrarTalleres = (comunaBuscada) => {
                    const terminoNormalizado = normalizarTexto(comunaBuscada);

                    const mapaActual = obtenerMapa();

                    if (!mapaActual) {
                        return;
                    }

                    marcadores.forEach((marcador) => marcador.setMap(null));
                    marcadores = [];

                    if (!terminoNormalizado) {
                        locationStatus.textContent = "Ingresa una comuna para ver los talleres disponibles en el mapa.";
                        mapaActual.setZoom(DEFAULT_ZOOM);
                        mapaActual.setCenter(DEFAULT_CENTER);
                        return;
                    }

                    const talleresEncontrados = talleresPorComuna.filter(
                        (taller) => normalizarTexto(taller.comuna) === terminoNormalizado
                    );

                    if (!talleresEncontrados.length) {
                        locationStatus.textContent = "No hay talleres en esa zona.";
                        mapaActual.setZoom(DEFAULT_ZOOM);
                        mapaActual.setCenter(DEFAULT_CENTER);
                        return;
                    }

                    const limites = new google.maps.LatLngBounds();

                    talleresEncontrados.forEach((taller) => {
                        const posicion = { lat: taller.lat, lng: taller.lng };
                        const marcador = new google.maps.Marker({
                            map: mapaActual,
                            position: posicion,
                            title: `${taller.nombre} - ${taller.comuna}`
                        });

                        const infoWindow = new google.maps.InfoWindow({
                            content: `<strong>${taller.nombre}</strong><br />${taller.direccion}<br />${taller.comuna}`
                        });

                        marcador.addListener("click", () => {
                            infoWindow.open({ anchor: marcador, map: mapaActual });
                        });

                        marcadores.push(marcador);
                        limites.extend(posicion);
                    });

                    if (talleresEncontrados.length === 1) {
                        mapaActual.setCenter(limites.getCenter());
                        mapaActual.setZoom(14);
                    } else {
                        mapaActual.fitBounds(limites, { padding: 60 });
                    }

                    const nombreComuna = talleresEncontrados[0].comuna;
                    const cantidad = talleresEncontrados.length;
                    const etiquetaTaller = cantidad === 1 ? "taller" : "talleres";
                    locationStatus.textContent = `Mostrando ${cantidad} ${etiquetaTaller} en ${nombreComuna}.`;
                    comunaInput.value = nombreComuna;
                };

                comunaForm.addEventListener("submit", (event) => {
                    event.preventDefault();
                    mostrarTalleres(comunaInput.value);
                });

                comunaInput.addEventListener("change", (event) => {
                    if (event.target.value) {
                        mostrarTalleres(event.target.value);
                    }
                });

                comunaInput.addEventListener("input", (event) => {
                    if (!event.target.value.trim()) {
                        const mapaActual = obtenerMapa();

                        if (mapaActual) {
                            marcadores.forEach((marcador) => marcador.setMap(null));
                            marcadores = [];
                            mapaActual.setZoom(DEFAULT_ZOOM);
                            mapaActual.setCenter(DEFAULT_CENTER);
                        }

                        locationStatus.textContent = "Ingresa una comuna para ver los talleres disponibles en el mapa.";
                    }
                });

                if (window.google && google.maps) {
                    window.initMap();
                }
            });
        </script>
        <script
            src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap"
            async
            defer
        ></script>
    </body>
</html>
