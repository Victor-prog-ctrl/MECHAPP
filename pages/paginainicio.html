<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Mechapp · Inicio</title>
    <meta name="description" content="Servicio automotriz profesional." />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />


    <!-- Tus estilos -->
    <link rel="stylesheet" href="../Styles/paginainicio.css" />

    <!-- Asegura altura del mapa -->
    <style>
      .map-container { height: 420px; width: 100%; border-radius: 12px; }
      @media (max-width: 768px) { .map-container { height: 300px; } }
      .map-controls { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
      .map-controls input { flex:1; min-width:220px; padding:8px; }
      .map-controls button, .map-controls select { padding:8px 12px; }
      .form-feedback { color:#b45454; margin-top:6px; }
    </style>
  </head>

  <body>
    <header class="site-header">
      <div class="brand">
        <img src="../assets/logo.png" alt="Mechapp" class="brand-logo" />
        <span class="brand-name">Mechapp</span>
      </div>
      <nav class="main-nav" aria-label="Principal">
        <a href="#inicio" class="nav-link active">Inicio</a>
        <a href="#citas" class="nav-link">Citas</a>
        <a href="./sobre-nosotros.html" class="nav-link">Sobre nosotros</a>
        <a href="#ubicacion" class="nav-link">Ubicación</a>
        <a href="./perfil.html" class="nav-link">Perfil</a>
        <a href="./registro-taller.html" class="nav-link" data-visible-for="mecanico" hidden>
          Registrar Taller
        </a>
      </nav>
      <div class="header-actions">
        <a href="./login.html" class="button button-secondary" data-auth-visibility="unauthenticated">Iniciar sesión</a>
        <a href="#agendar" class="button button-primary">Agendar Cita</a>
        <a href="./perfil.html" class="button ghost">Mi Perfil</a>
        <a href="./registro-taller.html" class="button ghost" data-visible-for="mecanico" hidden>
          Registrar Taller
        </a>
      </div>
    </header>

    <main>
      <section class="hero" id="inicio">
        <div class="hero-image" role="img" aria-label="Taller mecánico"></div>
        <div class="hero-content">
          <span class="hero-tag">Tus Técnicos</span>
          <h1>Confianza en Cada Reparación</h1>
          <p>Tu Solución para el Mantenimiento Automotriz.</p>
          <a class="button" href="./perfil.html">Ver Perfil</a>
        </div>
      </section>

      <section class="search-section" aria-labelledby="buscador">
        <div class="section-header">
          <div>
            <h2 id="buscador">Encuentra tu taller o servicio</h2>
            <p>Escribe el nombre de un especialista o servicio y descubre más detalles.</p>
          </div>
        </div>
        <div class="search-control">
          <label class="visually-hidden" for="search-input">Buscar talleres o servicios</label>
          <input type="search" id="search-input" placeholder="Ej. frenos, eléctrico, mantenimiento" autocomplete="off" />
        </div>
        <div class="search-results" id="search-results" aria-live="polite"></div>
      </section>

      <section class="services" id="citas" aria-labelledby="servicios">
        <div class="section-header">
          <div>
            <h2 id="servicios">Servicios Populares</h2>
            <p>Agenda los servicios más solicitados por nuestros clientes.</p>
          </div>
          <a class="button" href="#citas">Explorar</a>
        </div>
        <div class="grid">
          <article class="service-card">
            <div class="service-icon" aria-hidden="true"></div>
            <div>
              <h3>Mantenimiento General</h3>
              <p>Incluye revisión completa de fluidos y ajustes básicos.</p>
            </div>
            <a class="button ghost" href="#">Próximas Citas</a>
          </article>
          <article class="service-card">
            <div class="service-icon" aria-hidden="true"></div>
            <div>
              <h3>Diagnóstico Eléctrico</h3>
              <p>Soluciones precisas para problemas eléctricos del vehículo.</p>
            </div>
            <a class="button ghost" href="#">Próximas Citas</a>
          </article>
          <article class="service-card">
            <div class="service-icon" aria-hidden="true"></div>
            <div>
              <h3>Alineación y Balanceo</h3>
              <p>Mejora el rendimiento y la seguridad en carretera.</p>
            </div>
            <a class="button ghost" href="#">Próximas Citas</a>
          </article>
        </div>
      </section>

      <!-- ===== Sección de ubicación con Google Maps ===== -->
      <section class="location-section" id="ubicacion" aria-labelledby="geolocalizacion">
        <div class="section-header">
          <div>
            <h2 id="geolocalizacion">Busca el taller de tu comuna</h2>
            <p>Utiliza el buscador o selecciona una comuna para explorar el mapa.</p>
          </div>
        </div>

        <!-- Contenedor del mapa de Google -->
        <div
          id="map"
          class="map-container"
          role="region"
          aria-label="Mapa Google de comunas"
          style="height:420px; width:100%; border-radius:12px;"
        ></div>
      </section>
      <!-- ===== /Mapa ===== -->
    </main>

    <footer class="site-footer" id="mensajes">
      <div class="footer-column">
        <h4>Citas Directas</h4>
        <p>Atención personalizada para empresas y flotas.</p>
      </div>
      <div class="footer-column">
        <h4>Servicios Adicionales</h4>
        <ul>
          <li>Mantenimiento Preventivo</li>
          <li>Inspecciones Técnicas</li>
          <li>Reemplazo de Partes</li>
        </ul>
      </div>
      <div class="footer-column">
        <h4>Contacto</h4>
        <p>+34 900 123 456</p>
        <p>soporte@autoserv.com</p>
      </div>
    </footer>

    <!-- Tu lógica existente (no la toqué) -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.getElementById("search-input");
        const searchResults = document.getElementById("search-results");
        const mechanicOnlyElements = document.querySelectorAll('[data-visible-for="mecanico"]');
        const unauthenticatedOnlyElements = document.querySelectorAll('[data-auth-visibility="unauthenticated"]');

        const normalizeText = (t = "") =>
          t.toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ñ/g, "n");

        const updateMechanicElementsVisibility = (shouldShow) => {
          mechanicOnlyElements.forEach((el) => (shouldShow ? el.removeAttribute("hidden") : el.setAttribute("hidden", "")));
        };
        const updateAuthVisibility = (isAuthenticated) => {
          unauthenticatedOnlyElements.forEach((el) => (isAuthenticated ? el.setAttribute("hidden", "") : el.removeAttribute("hidden")));
        };

        const verifyMechanicProfile = async () => {
          try {
            const response = await fetch("/api/profile");
            if (!response.ok) {
              if (response.status === 401) { updateMechanicElementsVisibility(false); updateAuthVisibility(false); return; }
              throw new Error("No se pudo obtener el perfil del usuario");
            }
            const profile = await response.json();
            updateMechanicElementsVisibility(profile?.accountType === "mecanico");
            updateAuthVisibility(true);
          } catch (e) {
            console.error(e);
            updateMechanicElementsVisibility(false);
            updateAuthVisibility(false);
          }
        };
        verifyMechanicProfile();

        const servicios = [
          { nombre:"Mantenimiento General", descripcion:"Incluye revisión completa de fluidos y ajustes básicos.", enlace:"#", tipo:"Servicio" },
          { nombre:"Diagnóstico Eléctrico", descripcion:"Soluciones precisas para problemas eléctricos del vehículo.", enlace:"#", tipo:"Servicio" },
          { nombre:"Alineación y Balanceo", descripcion:"Mejora el rendimiento y la seguridad en carretera.", enlace:"#", tipo:"Servicio" }
        ];

        const marcasVehiculos = [
          "Abarth","Acura","Aiways","Alfa Romeo","Alpine","Ariel","Aston Martin","Audi","BAIC","Bentley",
          "BMW","Brilliance","Bugatti","Buick","BYD","Cadillac","Changan","Chery","Chevrolet","Chrysler",
          "Citroën","Cupra","Dacia","Daewoo","Daihatsu","Datsun","Dodge","Dongfeng","DS Automobiles","FAW",
          "Ferrari","Fiat","Fisker","Ford","Foton","GAC","Geely","Genesis","GMC","Great Wall",
          "Haval","Holden","Honda","Hummer","Hyundai","Infiniti","Isuzu","Iveco","JAC","Jaguar",
          "Jeep","JMC","Kia","Koenigsegg","KTM","Lada","Lamborghini","Lancia","Land Rover","Lexus",
          "Li Auto","Lincoln","Lotus","Lucid","Mahindra","Maserati","Maybach","Mazda","McLaren","Mercedes-Benz",
          "MG","Mini","Mitsubishi","NIO","Nissan","Opel","Pagani","Peugeot","Polestar","Pontiac",
          "Porsche","Proton","RAM","Renault","Rivian","Rolls-Royce","Rover","Saab","Scion","SEAT",
          "Škoda","Smart","SsangYong","Subaru","Suzuki","Tata","Tesla","Toyota","TVR","Vauxhall",
          "VinFast","Volkswagen","Volvo","Wuling","Zotye"
        ].map((marca) => ({
          nombre: marca,
          descripcion: "Marca de vehículos disponible para servicios especializados.",
          enlace: "#",
          tipo: "Marca"
        }));

        const datosBusqueda = [...servicios, ...marcasVehiculos];

        const renderResultados = (items) => {
          const el = document.getElementById("search-results");
          if (!items.length) { el.innerHTML = '<p class="empty-results">No encontramos resultados que coincidan con tu búsqueda.</p>'; return; }
          const frag = document.createDocumentFragment();
          items.forEach((item) => {
            const article = document.createElement("article");
            article.className = "result-item";
            article.innerHTML = `
              <div class="result-type" aria-hidden="true">${item.tipo}</div>
              <div class="result-content">
                <h3>${item.nombre}</h3>
                <p>${item.especialidad || item.descripcion}</p>
              </div>
              <a class="button ghost" href="${item.enlace}">Ver más</a>
            `;
            frag.appendChild(article);
          });
          el.innerHTML = "";
          el.appendChild(frag);
        };
        renderResultados(datosBusqueda.slice(0,3));
        searchInput?.addEventListener("input", (e) => {
          const termino = normalizeText(e.target.value);
          if (!termino) { renderResultados(datosBusqueda.slice(0,3)); return; }
          const filtrados = datosBusqueda.filter((it) =>
            normalizeText(`${it.nombre} ${it.especialidad || ""} ${it.descripcion || ""}`).includes(termino)
          );
          renderResultados(filtrados);
        });
      });
    </script>

    <!-- Google Maps JS (reemplaza TU_API_KEY_AQUI) -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATF7l8QIpx6dlv2icl48TYG5N1PJVLdcw&callback=initGMap"
      async defer>
    </script>

    <!-- Inicialización del mapa de Google (definida en window) -->
<!-- 1) La función va en window para que el callback la encuentre -->
<script>
  window.initGMap = function () {
    const el = document.getElementById('map');
    if (!el.style.height) el.style.height = '420px'; // por si el CSS no cargó

    const center = { lat: -33.4489, lng: -70.6693 };
    const map = new google.maps.Map(el, {
      center,
      zoom: 12,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: true,
    });
    new google.maps.Marker({ map, position: center, title: 'Mechapp · Centro' });
    console.log('[GMaps] Mapa inicializado');
  };
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATF7l8QIpx6dlv2icl48TYG5N1PJVLdcw&callback=initGMap&v=weekly" async defer></script>

  </body>
</html>
