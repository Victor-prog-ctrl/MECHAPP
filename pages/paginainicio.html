<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Mechapp · Inicio</title>
  <meta name="description" content="Servicio automotriz profesional." />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Tus estilos -->
  <link rel="stylesheet" href="../Styles/paginainicio.css" />
  <link rel="stylesheet" href="../Styles/chatbot.css" />

</head>

<body>
  <header class="site-header">
    <div class="brand">
      <img src="../assets/logo.png" alt="Mechapp" class="brand-logo" />
      <span class="brand-name">Mechapp</span>
    </div>
    <nav class="main-nav" aria-label="Principal">
      <a href="#inicio" class="nav-link active">Inicio</a>
      <a href="./sobre-nosotros.html" class="nav-link">Sobre nosotros</a>
      <a href="./resenas-mecanicos.html" class="nav-link">Reseñas</a>
      <a href="./agendar-cita.html" class="nav-link" data-visible-for="usuario" hidden>Agendar cita</a>
      <a href="#ubicacion" class="nav-link">Ubicación</a>
      <a href="./registro-taller.html" class="nav-link" data-auth-visibility="authenticated" data-visible-for="mecanico"
        hidden>
        Registrar Taller
      </a>
    </nav>
    <div class="header-actions">
      <a href="./login.html" class="button button-primary" data-auth-visibility="unauthenticated">Iniciar sesión</a>
      <a href="./perfil.html" class="button ghost" data-auth-visibility="authenticated" hidden>Mi Perfil</a>
    </div>
  </header>

  <main>
    <section class="hero" id="inicio">
      <div class="hero-image" role="img" aria-label="Taller mecánico"></div>
      <div class="hero-content">
        <span class="hero-tag">Tus Técnicos</span>
        <h1>Confianza en Cada Reparación</h1>
        <p>Tu Solución para el Mantenimiento Automotriz.</p>
        <a class="button" href="./perfil.html">Ver Perfil</a>
      </div>
    </section>

    <section class="featured-services" aria-labelledby="featured-services-title">
      <div class="section-header">
        <div>
          <h2 id="featured-services-title">Servicios destacados en Mechapp</h2>
          <p>Descubre las especialidades más solicitadas por los talleres registrados y navega por ellas.</p>
        </div>
      </div>
      <div class="featured-services-carousel" data-featured-services aria-live="polite">
        <button class="featured-services-nav featured-services-nav--prev" type="button" aria-label="Ver servicios anteriores" data-featured-prev>
          <span aria-hidden="true">&#10094;</span>
        </button>
        <div class="featured-services-track-wrapper">
          <div class="featured-services-track" data-featured-track></div>
        </div>
        <button class="featured-services-nav featured-services-nav--next" type="button" aria-label="Ver servicios siguientes" data-featured-next>
          <span aria-hidden="true">&#10095;</span>
        </button>
      </div>
    </section>

    <section class="workshops" aria-labelledby="workshops-title">
      <div class="section-header">
        <div>
          <h2 id="workshops-title">Talleres verificados en Mechapp</h2>
          <p>Conoce a los especialistas inscritos y accede a su perfil para solicitar servicios o dejar una reseña.</p>
        </div>
      </div>
      <div class="workshops-carousel">
        <button class="workshops-nav workshops-nav--prev" type="button" aria-label="Ver talleres anteriores" data-carousel-prev>
          <span aria-hidden="true">&#10094;</span>
        </button>
        <div class="workshops-track-wrapper">
          <div class="workshops-grid" data-home-workshops aria-live="polite"></div>
        </div>
        <button class="workshops-nav workshops-nav--next" type="button" aria-label="Ver talleres siguientes" data-carousel-next>
          <span aria-hidden="true">&#10095;</span>
        </button>
      </div>
    </section>

    <section class="search-section" aria-labelledby="buscador">
      <div class="section-header">
        <div>
          <h2 id="buscador">Encuentra tu taller o servicio</h2>
          <p>Escribe el nombre de un taller para ver sus detalles y reseñas.</p>
        </div>
      </div>
      <div class="search-control">
        <label class="visually-hidden" for="search-input">Buscar talleres por nombre</label>
        <input type="search" id="search-input" placeholder="Ej. Taller Los Andes" autocomplete="off" />
      </div>
      <div class="search-results" id="search-results" aria-live="polite" hidden></div>

      <div class="services-search" data-services-search hidden>
        <div class="services-header">
          <h3>Qué servicios buscas</h3>
          <p>Explora los servicios disponibles y descubre talleres especializados.</p>
        </div>
        <div class="services-carousel">
          <button class="services-nav services-nav--prev" type="button" aria-label="Ver servicios anteriores" data-service-prev>
            <span aria-hidden="true">&#10094;</span>
          </button>
          <div class="services-track-wrapper" data-service-wrapper>
            <div class="services-track" data-service-track></div>
          </div>
          <button class="services-nav services-nav--next" type="button" aria-label="Ver servicios siguientes" data-service-next>
            <span aria-hidden="true">&#10095;</span>
          </button>
        </div>
        <div class="service-results search-results" id="service-results" aria-live="polite" hidden></div>
      </div>
    </section>

    <!-- ===== Sección de ubicación con Google Maps ===== -->
    <section class="location-section" id="ubicacion" aria-labelledby="geolocalizacion">
      <div class="section-header">
        <div>
          <h2 id="geolocalizacion">Busca el taller de tu comuna</h2>
          <p>Utiliza el buscador o selecciona una comuna para explorar el mapa.</p>
        </div>
      </div>

      <!-- Controles del mapa -->
      <div class="map-controls">
        <input id="comuna-input" type="text" placeholder="Busca una comuna (ej. Santiago)" autocomplete="off" />
        <button id="comuna-btn" class="button button-primary" type="button">Buscar comuna</button>
        <select id="comuna-select" aria-label="Comunas rápidas">
          <option value="">— Selecciona una comuna —</option>
          <option>Santiago</option>
          <option>Providencia</option>
          <option>Ñuñoa</option>
          <option>Las Condes</option>
          <option>Vitacura</option>
          <option>Maipú</option>
          <option>Puente Alto</option>
          <option>La Florida</option>
          <option>San Bernardo</option>
          <option>Peñalolén</option>
          <option>La Reina</option>
          <option>Quilicura</option>
        </select>
        <button id="mi-ubicacion-btn" class="button" type="button">Mi ubicación</button>
      </div>

      <p class="location-status" id="location-status" aria-live="polite">
        Mapa centrado en Santiago. Usa el buscador, el selector o “Mi ubicación”.
      </p>

      <!-- Contenedor del mapa de Google -->
      <div id="map" class="map-container" role="region" aria-label="Mapa Google de comunas"></div>
    </section>
    <!-- ===== /Mapa ===== -->
  </main>

  <footer class="site-footer" id="mensajes">
    <div class="footer-column">
      <h4>Citas Directas</h4>
      <p>Atención personalizada para empresas y flotas.</p>
    </div>
    <div class="footer-column">
      <h4>Servicios Adicionales</h4>
      <ul>
        <li>Mantenimiento Preventivo</li>
        <li>Inspecciones Técnicas</li>
        <li>Reemplazo de Partes</li>
      </ul>
    </div>
    <div class="footer-column">
      <h4>Contacto</h4>
      <p>+34 900 123 456</p>
      <p>soporte@autoserv.com</p>
    </div>
  </footer>

  <script src="../src/home-workshops.js" defer></script>
  <script src="../src/home-services.js" defer></script>

  <!-- Lógica de búsqueda de talleres y exploración de servicios -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.getElementById("search-input");
      const searchResults = document.getElementById("search-results");
      const visibilityTargets = document.querySelectorAll('[data-auth-visibility], [data-visible-for]');
      const unauthenticatedOnlyElements = document.querySelectorAll('[data-auth-visibility="unauthenticated"]');
      const authenticatedOnlyElements = document.querySelectorAll('[data-auth-visibility="authenticated"]');
      const mechanicOnlyElements = document.querySelectorAll('[data-visible-for="mecanico"]');
      const userOnlyElements = document.querySelectorAll('[data-visible-for="usuario"]');

      const visibilityState = {
        isAuthenticated: false,
        isMechanic: false,
      };

      const normalizeText = (t = "") =>
        t.toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ñ/g, "n");

      const setElementVisibility = (el, shouldShow) => {
        if (shouldShow) {
          el.removeAttribute("hidden");
        } else {
          el.setAttribute("hidden", "");
        }
      };

      const applyVisibilityState = () => {
        const { isAuthenticated, isMechanic } = visibilityState;

        unauthenticatedOnlyElements.forEach((el) => {
          setElementVisibility(el, !isAuthenticated);
        });

        authenticatedOnlyElements.forEach((el) => {
          setElementVisibility(el, isAuthenticated);
        });

        mechanicOnlyElements.forEach((el) => {
          setElementVisibility(el, isAuthenticated && isMechanic);
        });

        userOnlyElements.forEach((el) => {
          setElementVisibility(el, isAuthenticated && !isMechanic);
        });

        visibilityTargets.forEach((el) => {
          if (el.dataset.authVisibility || el.dataset.visibleFor) {
            return;
          }
          setElementVisibility(el, true);
        });
      };

      const verifyMechanicProfile = async () => {
        try {
          const response = await fetch("/api/profile");
          if (!response.ok) {
            if (response.status === 401) {
              visibilityState.isAuthenticated = false;
              visibilityState.isMechanic = false;
              applyVisibilityState();
              return;
            }
            throw new Error("No se pudo obtener el perfil del usuario");
          }
          const profile = await response.json();
          visibilityState.isAuthenticated = true;
          visibilityState.isMechanic = profile?.accountType === "mecanico";
          applyVisibilityState();
        } catch (e) {
          console.error(e);
          visibilityState.isAuthenticated = false;
          visibilityState.isMechanic = false;
          applyVisibilityState();
        }
      };
      verifyMechanicProfile();

      applyVisibilityState();

      const servicesSearchContainer = document.querySelector("[data-services-search]");
      const servicesTrack = document.querySelector("[data-service-track]");
      const serviceWrapper = document.querySelector("[data-service-wrapper]");
      const servicePrevButton = document.querySelector("[data-service-prev]");
      const serviceNextButton = document.querySelector("[data-service-next]");
      const serviceResults = document.getElementById("service-results");

      const SEARCH_LOADING_MESSAGE = '<p class="empty-results">Estamos cargando los talleres…</p>';
      const SEARCH_ERROR_MESSAGE = '<p class="empty-results">No se pudieron cargar los talleres. Intenta nuevamente más tarde.</p>';
      const SEARCH_EMPTY_MESSAGE = '<p class="empty-results">No encontramos talleres que coincidan con tu búsqueda.</p>';

      let workshops = [];
      let serviceEntries = [];
      let activeServiceKey = null;
      let workshopsReady = false;
      let workshopsLoadError = false;

      function createWorkshopResult(workshop) {
        const article = document.createElement("article");
        article.className = "result-item";

        const type = document.createElement("div");
        type.className = "result-type";
        type.textContent = "Taller";
        type.setAttribute("aria-hidden", "true");
        article.appendChild(type);

        const content = document.createElement("div");
        content.className = "result-content";

        const title = document.createElement("h3");
        title.textContent = workshop.name;
        content.appendChild(title);

        const description = document.createElement("p");
        description.textContent = workshop.shortDescription || "Sin descripción disponible.";
        content.appendChild(description);

        article.appendChild(content);

        const link = document.createElement("a");
        link.className = "button ghost";
        link.href = `./perfil-taller.html?id=${encodeURIComponent(workshop.id)}`;
        link.textContent = "Ver más";
        link.setAttribute("aria-label", `Ver perfil del taller ${workshop.name}`);
        article.appendChild(link);

        return article;
      }

      function renderSearchResults(items) {
        if (!searchResults) {
          return;
        }

        if (!items.length) {
          searchResults.innerHTML = SEARCH_EMPTY_MESSAGE;
          return;
        }

        const fragment = document.createDocumentFragment();
        items.forEach((workshop) => {
          fragment.appendChild(createWorkshopResult(workshop));
        });
        searchResults.innerHTML = "";
        searchResults.appendChild(fragment);
      }

      function updateActiveServiceButton(serviceKey) {
        if (!servicesTrack) {
          return;
        }
        servicesTrack.querySelectorAll(".service-pill").forEach((button) => {
          const isActive = button.dataset.serviceKey === serviceKey;
          button.classList.toggle("service-pill--active", isActive);
          button.setAttribute("aria-pressed", isActive ? "true" : "false");
        });
      }

      function renderServiceResults(entry) {
        if (!serviceResults) {
          return;
        }

        if (!entry) {
          serviceResults.innerHTML = "";
          serviceResults.setAttribute("hidden", "");
          updateActiveServiceButton(null);
          return;
        }

        const fragment = document.createDocumentFragment();
        const heading = document.createElement("h4");
        heading.className = "service-results__title";
        heading.textContent = `Talleres que ofrecen ${entry.name}`;
        fragment.appendChild(heading);

        if (!entry.workshops.length) {
          const empty = document.createElement("p");
          empty.className = "empty-results";
          empty.textContent = "No encontramos talleres con este servicio.";
          fragment.appendChild(empty);
        } else {
          entry.workshops.forEach((workshop) => {
            fragment.appendChild(createWorkshopResult(workshop));
          });
        }

        serviceResults.innerHTML = "";
        serviceResults.appendChild(fragment);
        serviceResults.removeAttribute("hidden");
        updateActiveServiceButton(entry.key);
      }

      function getServiceScrollAmount() {
        if (!serviceWrapper || !servicesTrack) {
          return 0;
        }

        const firstPill = servicesTrack.querySelector(".service-pill");
        if (!firstPill) {
          return serviceWrapper.clientWidth;
        }

        const pillWidth = firstPill.getBoundingClientRect().width;
        const styles = window.getComputedStyle(servicesTrack);
        const gap = [styles.columnGap, styles.gap, styles.rowGap]
          .map((value) => {
            const parsed = Number.parseFloat(value);
            return Number.isNaN(parsed) ? 0 : parsed;
          })
          .find((value) => value > 0) || 0;

        return pillWidth + gap;
      }

      function updateServiceNavButtons() {
        if (!serviceWrapper || !servicePrevButton || !serviceNextButton || !servicesTrack) {
          return;
        }

        const hasContent = servicesTrack.children.length > 0 && !servicesTrack.classList.contains("services-track--empty");
        const maxScroll = Math.max(0, serviceWrapper.scrollWidth - serviceWrapper.clientWidth);
        const currentScroll = serviceWrapper.scrollLeft;

        servicePrevButton.disabled = !hasContent || currentScroll <= 0;
        serviceNextButton.disabled = !hasContent || currentScroll >= maxScroll - 1;
      }

      function scrollServices(direction) {
        if (!serviceWrapper) {
          return;
        }
        const amount = getServiceScrollAmount();
        if (!amount) {
          return;
        }
        serviceWrapper.scrollBy({ left: direction * amount, behavior: "smooth" });
      }

      function handleServiceSelection(serviceKey) {
        if (!serviceKey) {
          return;
        }

        if (activeServiceKey === serviceKey) {
          activeServiceKey = null;
          renderServiceResults(null);
          return;
        }

        activeServiceKey = serviceKey;
        const entry = serviceEntries.find((item) => item.key === serviceKey) || null;
        renderServiceResults(entry);
      }

      if (servicePrevButton && serviceNextButton && serviceWrapper) {
        servicePrevButton.addEventListener("click", () => scrollServices(-1));
        serviceNextButton.addEventListener("click", () => scrollServices(1));
        serviceWrapper.addEventListener("scroll", updateServiceNavButtons, { passive: true });
        window.addEventListener("resize", updateServiceNavButtons);
      }

      function buildServiceEntries(list) {
        if (!servicesTrack || !servicesSearchContainer) {
          return;
        }

        const map = new Map();
        list.forEach((workshop) => {
          const serviceList = Array.isArray(workshop.services) ? workshop.services : [];
          const seenServiceKeys = new Set();
          serviceList.forEach((serviceName) => {
            if (!serviceName || typeof serviceName !== "string") {
              return;
            }
            const trimmed = serviceName.trim().replace(/\s+/g, " ");
            if (!trimmed) {
              return;
            }
            const key = normalizeText(trimmed).replace(/\s+/g, " ");
            if (!key) {
              return;
            }
            if (seenServiceKeys.has(key)) {
              return;
            }
            seenServiceKeys.add(key);

            if (!map.has(key)) {
              map.set(key, { key, name: trimmed, workshops: [], workshopIds: new Set() });
            }
            const entry = map.get(key);
            if (!entry.workshopIds.has(workshop.id)) {
              entry.workshopIds.add(workshop.id);
              entry.workshops.push(workshop);
            }
          });
        });

        serviceEntries = Array.from(map.values())
          .map(({ key, name, workshops }) => ({ key, name, workshops }))
          .sort((a, b) => a.name.localeCompare(b.name, "es", { sensitivity: "base" }));

        servicesTrack.classList.remove("services-track--empty");
        servicesTrack.innerHTML = "";
        activeServiceKey = null;
        updateActiveServiceButton(null);
        renderServiceResults(null);

        if (!serviceEntries.length) {
          servicesSearchContainer.hidden = false;
          servicesTrack.classList.add("services-track--empty");
          servicesTrack.innerHTML = '<p class="services-empty-message empty-results">Aún no hay servicios registrados.</p>';
          if (servicePrevButton) { servicePrevButton.disabled = true; }
          if (serviceNextButton) { serviceNextButton.disabled = true; }
          return;
        }

        const fragment = document.createDocumentFragment();
        serviceEntries.forEach((entry) => {
          const button = document.createElement("button");
          button.type = "button";
          button.className = "service-pill";
          button.textContent = entry.name;
          button.dataset.serviceKey = entry.key;
          button.setAttribute("aria-pressed", "false");
          button.addEventListener("click", () => handleServiceSelection(entry.key));
          fragment.appendChild(button);
        });

        servicesTrack.appendChild(fragment);
        servicesSearchContainer.hidden = false;
        updateServiceNavButtons();
      }

      async function loadWorkshops() {
        workshopsReady = false;
        workshopsLoadError = false;
        try {
          const response = await fetch("/api/workshops");
          if (!response.ok) {
            throw new Error("No se pudieron cargar los talleres");
          }
          const data = await response.json();
          workshops = Array.isArray(data?.workshops) ? data.workshops : [];
          workshopsReady = true;
          buildServiceEntries(workshops);
          if (searchInput && searchInput.value.trim()) {
            searchInput.dispatchEvent(new Event("input"));
          }
        } catch (error) {
          console.error(error);
          workshops = [];
          workshopsReady = false;
          workshopsLoadError = true;
          if (servicesSearchContainer) {
            servicesSearchContainer.hidden = false;
          }
          if (serviceResults) {
            serviceResults.innerHTML = '<p class="empty-results">No se pudieron cargar los servicios en este momento.</p>';
            serviceResults.removeAttribute("hidden");
          }
          if (servicesTrack) {
            servicesTrack.classList.add("services-track--empty");
            servicesTrack.innerHTML = '<p class="services-empty-message empty-results">Intenta nuevamente más tarde.</p>';
            activeServiceKey = null;
            updateActiveServiceButton(null);
          }
          if (servicePrevButton) { servicePrevButton.disabled = true; }
          if (serviceNextButton) { serviceNextButton.disabled = true; }
          updateServiceNavButtons();
        }
      }

      searchInput?.addEventListener("input", (event) => {
        const term = normalizeText(event.target.value);
        if (!searchResults) {
          return;
        }

        if (!term) {
          searchResults.innerHTML = "";
          searchResults.setAttribute("hidden", "");
          return;
        }

        searchResults.removeAttribute("hidden");

        if (workshopsLoadError) {
          searchResults.innerHTML = SEARCH_ERROR_MESSAGE;
          return;
        }

        if (!workshopsReady) {
          searchResults.innerHTML = SEARCH_LOADING_MESSAGE;
          return;
        }

        const filtered = workshops.filter((workshop) => normalizeText(workshop.name).includes(term));
        renderSearchResults(filtered);
      });

      loadWorkshops();
    });
  </script>

  <!-- Inicialización del mapa de Google y funcionalidad -->
  <script>
    // ==== Bloque JS de Google Maps ====
    window.initGMap = function () {
      const CL_REGION_SUFFIX = ", Región Metropolitana, Chile";
      const DEFAULT_CENTER = { lat: -33.4489, lng: -70.6693 };
      const DEFAULT_ZOOM = 12;
      const SEARCH_ZOOM = 13;
      const RADIUS_METERS = 4000;

      const $ = (id) => document.getElementById(id);
      const setStatus = (msg) => { const el = $("location-status"); if (el) el.textContent = msg; };

      // === ICONOS por URL (NO SVG path) ===
      const ICONS = {
        taller: {
          url: "assets/logo-oscuro.png",
          size: new google.maps.Size(55, 60), scaledSize: new google.maps.Size(55, 60),
          anchor: new google.maps.Point(14, 28)
        },
        vulca: {
          url: "assets/vulca-Photoroom.png",
          size: new google.maps.Size(55, 60), scaledSize: new google.maps.Size(55, 60),
          anchor: new google.maps.Point(14, 28)
        },
        user: {
          url: "/assets/markers/user-blue.png",
          size: new google.maps.Size(28, 28), scaledSize: new google.maps.Size(28, 28),
          anchor: new google.maps.Point(14, 28)
        },
        center: {
          url: "/assets/icono-central-mapa.jpg",
          size: new google.maps.Size(45, 55), scaledSize: new google.maps.Size(45, 55),
          anchor: new google.maps.Point(22, 34)
        }
      };

      let map, geocoder, autocomplete, userMarker = null, placeMarkers = [];
      let centerMarker = null; // marcador del centro de la comuna

      function clearPlaceMarkers() { placeMarkers.forEach(m => m.setMap(null)); placeMarkers = []; }
      function addPlaceMarker(pos, tipo, nombre) {
        const iconCfg = (tipo === "vulcanizacion") ? ICONS.vulca : ICONS.taller;
        const marker = new google.maps.Marker({
          position: pos, map, icon: iconCfg,
          title: nombre || (tipo === "vulcanizacion" ? "Vulcanización" : "Taller mecánico")
        });
        const iw = new google.maps.InfoWindow({
          content: `<strong>${nombre || (tipo === "vulcanizacion" ? "Vulcanización" : "Taller mecánico")}</strong><br><small>${tipo}</small>`
        });
        marker.addListener("click", () => iw.open({ anchor: marker, map }));
        placeMarkers.push(marker);
      }
      function samplePlaces(center) {
        const dx = (Math.random() - 0.5) * 0.04, dy = (Math.random() - 0.5) * 0.04;
        return [
          { lat: center.lat + dx, lng: center.lng + dy, tipo: "taller", nombre: "Taller Don Pepe" },
          { lat: center.lat + dy, lng: center.lng - dx, tipo: "vulcanizacion", nombre: "Vulcanización La Rueda" },
          { lat: center.lat - dx, lng: center.lng + dy, tipo: "taller", nombre: "Servicio Mecánico Andes" },
        ];
      }
      async function loadPlaces(center, comunaNombre) {
        clearPlaceMarkers();
        try {
          const res = await fetch("/data/talleres.json");
          const data = await res.json();

          // Filtra talleres por comuna
          const items = data.filter(p =>
            comunaNombre && p.comuna.toLowerCase() === comunaNombre.toLowerCase()
          );

          if (items.length > 0) {
            items.forEach(p => addPlaceMarker({ lat: p.lat, lng: p.lng }, p.tipo, p.nombre));
            setStatus(`Mostrando ${items.length} talleres/vulcanizaciones en ${comunaNombre}.`);
          } else {
            setStatus(`No hay talleres registrados para ${comunaNombre}.`);
          }

        } catch (err) {
          console.error("Error cargando talleres.json", err);
          setStatus("No se pudieron cargar los talleres de esta comuna.");
        }
      }

      function focus(center, comunaNombre) {
        map.setCenter(center);
        map.setZoom(SEARCH_ZOOM);

        // marcador del centro de la comuna
        if (!centerMarker) {
          centerMarker = new google.maps.Marker({
            position: center, map, icon: ICONS.center,
            title: comunaNombre ? `Centro: ${comunaNombre}` : "Centro de la zona"
          });
        } else {
          centerMarker.setPosition(center);
          centerMarker.setIcon(ICONS.center);
          centerMarker.setTitle(comunaNombre ? `Centro: ${comunaNombre}` : "Centro de la zona");
        }

        setStatus(`Mostrando comuna: ${comunaNombre || "—"}.`);
        loadPlaces(center, comunaNombre);
      }
      function geolocate() {
        if (!navigator.geolocation) { setStatus("Tu navegador no admite geolocalización."); return; }
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const center = { lat: pos.coords.latitude, lng: pos.coords.longitude };

          // marcador del usuario
          if (!userMarker) {
            userMarker = new google.maps.Marker({ position: center, map, icon: ICONS.user, title: "Estás aquí" });
          } else {
            userMarker.setPosition(center);
            userMarker.setIcon(ICONS.user);
          }

          try {
            const resp = await geocoder.geocode({ location: center });
            const commune = (resp.results[0]?.address_components || []).find(c => c.types.includes("locality"))?.long_name || "tu ubicación";
            focus(center, commune);
          } catch { focus(center, "tu ubicación"); }
        }, () => setStatus("No se pudo obtener tu ubicación."), { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 });
      }

      // === Inicializar mapa ===
      const el = document.getElementById("map");
      if (!el.style.height) el.style.height = "420px";

      map = new google.maps.Map(el, {
        center: DEFAULT_CENTER, zoom: DEFAULT_ZOOM,
        mapTypeControl: false, streetViewControl: false, fullscreenControl: true,
        gestureHandling: "greedy", scrollwheel: false
      });
      geocoder = new google.maps.Geocoder();

      // Autocomplete + eventos
      const input = document.getElementById("comuna-input");
      autocomplete = new google.maps.places.Autocomplete(input, {
        fields: ["geometry", "name", "address_components"],
        types: ["(regions)"], componentRestrictions: { country: "cl" }
      });
      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        const loc = place.geometry?.location; if (!loc) return;
        focus({ lat: loc.lat(), lng: loc.lng() }, place.name || "Comuna");
      });

      document.getElementById("comuna-btn").addEventListener("click", async () => {
        const q = input.value.trim(); if (!q) return;
        try {
          const resp = await geocoder.geocode({ address: q + CL_REGION_SUFFIX });
          const loc = resp.results[0]?.geometry?.location; if (!loc) return setStatus("No encontramos esa comuna.");
          const comuna = (resp.results[0].address_components || []).find(c => c.types.includes("locality"))?.long_name || q;
          focus({ lat: loc.lat(), lng: loc.lng() }, comuna);
        } catch { setStatus("No se pudo geocodificar esa comuna."); }
      });
      input.addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); document.getElementById("comuna-btn").click(); } });

      document.getElementById("comuna-select").addEventListener("change", async (e) => {
        const v = e.target.value; if (!v) return;
        try {
          const resp = await geocoder.geocode({ address: v + CL_REGION_SUFFIX });
          const loc = resp.results[0]?.geometry?.location; if (!loc) return;
          focus({ lat: loc.lat(), lng: loc.lng() }, v);
        } catch { setStatus("No se pudo cargar esa comuna."); }
      });

      document.getElementById("mi-ubicacion-btn").addEventListener("click", geolocate);

      // Carga inicial
      focus(DEFAULT_CENTER, "Santiago");
    };
  </script>

  <!-- SDK de Google Maps (una sola vez). Reemplaza la key si corresponde -->
  <script src="../src/chatbot.js" defer></script>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATF7l8QIpx6dlv2icl48TYG5N1PJVLdcw&callback=initGMap&libraries=places&v=weekly"
    async defer></script>
</body>

</html>
