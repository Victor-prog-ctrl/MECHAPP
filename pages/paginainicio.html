<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Mechapp · Inicio</title>
  <meta name="description" content="Servicio automotriz profesional." />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" type="image/png" href="/assets/logo.png" />

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Tus estilos -->
  <link rel="stylesheet" href="../Styles/paginainicio.css" />
  <link rel="stylesheet" href="../Styles/chatbot.css" />

</head>

<body>
  <header class="site-header">
    <div class="brand">
      <img src="../assets/logo.png" alt="Mechapp" class="brand-logo" />
      <span class="brand-name">Mechapp</span>
    </div>
    <nav class="main-nav" aria-label="Principal">
      <a href="#inicio" class="nav-link active">Inicio</a>
      <a href="./sobre-nosotros.html" class="nav-link">Sobre nosotros</a>
      <a href="./resenas-mecanicos.html" class="nav-link">Reseñas</a>
      <a href="./agendar-cita.html" class="nav-link" data-visible-for="usuario" hidden>Agendar cita</a>
      <a href="#ubicacion" class="nav-link">Ubicación</a>
      <a href="./registro-taller.html" class="nav-link" data-auth-visibility="authenticated" data-visible-for="mecanico"
        hidden>
        Registrar Taller
      </a>
    </nav>
    <div class="header-actions">
      <div class="notification-center" data-auth-visibility="authenticated" data-notification-center hidden>
        <button
          type="button"
          class="notification-bell"
          aria-label="Abrir notificaciones"
          aria-expanded="false"
          aria-haspopup="true"
          data-notification-toggle
        >
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="notification-bell__icon">
            <path
              d="M12 2a6 6 0 0 0-6 6v3.382l-.894 2.236A1 1 0 0 0 6.03 15h11.94a1 1 0 0 0 .924-1.382L18 11.382V8a6 6 0 0 0-6-6Z"
            />
            <path d="M9 18a3 3 0 0 0 6 0H9Z" />
          </svg>
          <span class="notification-count" data-notification-count hidden>0</span>
        </button>
        <div class="notification-panel" data-notification-panel hidden role="region" aria-live="polite">
          <div class="notification-panel__header">
            <div>
              <p class="notification-panel__label">Centro de notificaciones</p>
              <p class="notification-panel__title">Tus avisos</p>
            </div>
            <button type="button" class="notification-panel__close" aria-label="Cerrar" data-notification-close>
              &times;
            </button>
          </div>
          <ul class="notification-list" data-notification-list aria-label="Notificaciones"></ul>
          <p class="notification-empty" data-notification-empty hidden>No tienes notificaciones nuevas.</p>
        </div>
      </div>
      <a href="./login.html" class="button button-primary" data-auth-visibility="unauthenticated">Iniciar sesión</a>
      <a href="./perfil.html" class="button ghost" data-auth-visibility="authenticated" hidden>Mi Perfil</a>
    </div>
  </header>

  <main>
    <section class="hero" id="inicio">
      <div class="hero-image" role="img" aria-label="Taller mecánico"></div>
      <div class="hero-content">
        <span class="hero-tag">Tus Técnicos</span>
        <h1>Confianza en Cada Reparación</h1>
        <p>Tu Solución para el Mantenimiento Automotriz.</p>
        <a class="button" href="./perfil.html">Ver Perfil</a>
      </div>
    </section>

    <section class="search-section" aria-labelledby="buscador">
      <div class="section-header">
        <div>
          <h2 id="buscador">Encuentra tu taller de confianza</h2>
          <p>Escribe el nombre de un taller para ver sus detalles y reseñas.</p>
        </div>
      </div>
      <div class="search-control">
        <label class="visually-hidden" for="search-input">Buscar talleres por nombre</label>
        <input type="search" id="search-input" placeholder="Ej. Taller Los Andes" autocomplete="off" />
      </div>
      <div class="search-results" id="search-results" aria-live="polite" hidden></div>

    </section>

    <section class="featured-services" aria-labelledby="featured-services-title">
      <div class="section-header">
        <div>
          <h2 id="featured-services-title">Servicios destacados en Mechapp</h2>
          <p>Descubre las especialidades más solicitadas por los talleres registrados y navega por ellas.</p>
        </div>
      </div>
      <div class="featured-services-carousel" data-featured-services aria-live="polite">
        <button class="featured-services-nav featured-services-nav--prev" type="button" aria-label="Ver servicios anteriores" data-featured-prev>
          <span aria-hidden="true">&#10094;</span>
        </button>
        <div class="featured-services-track-wrapper">
          <div class="featured-services-track" data-featured-track></div>
        </div>
        <button class="featured-services-nav featured-services-nav--next" type="button" aria-label="Ver servicios siguientes" data-featured-next>
          <span aria-hidden="true">&#10095;</span>
        </button>
      </div>
    </section>

    <section class="workshops" aria-labelledby="workshops-title">
      <div class="section-header">
        <div>
          <h2 id="workshops-title">Talleres verificados en Mechapp</h2>
          <p>Conoce a los especialistas inscritos y accede a su perfil para solicitar servicios o dejar una reseña.</p>
        </div>
      </div>
      <div class="workshops-carousel">
        <button class="workshops-nav workshops-nav--prev" type="button" aria-label="Ver talleres anteriores" data-carousel-prev>
          <span aria-hidden="true">&#10094;</span>
        </button>
        <div class="workshops-track-wrapper">
          <div class="workshops-grid" data-home-workshops aria-live="polite"></div>
        </div>
        <button class="workshops-nav workshops-nav--next" type="button" aria-label="Ver talleres siguientes" data-carousel-next>
          <span aria-hidden="true">&#10095;</span>
        </button>
      </div>
    </section>

    <!-- ===== Sección de ubicación con Google Maps ===== -->
    <section class="location-section" id="ubicacion" aria-labelledby="geolocalizacion">
      <div class="section-header">
        <div>
          <h2 id="geolocalizacion">Busca el taller de tu comuna</h2>
          <p>Utiliza el buscador o selecciona una comuna para explorar el mapa.</p>
        </div>
      </div>

      <!-- Controles del mapa -->
      <div class="map-controls">
        <input id="comuna-input" type="text" placeholder="Busca una comuna (ej. Santiago)" autocomplete="off" />
        <button id="comuna-btn" class="button button-primary" type="button">Buscar comuna</button>
        <select id="comuna-select" aria-label="Comunas rápidas">
          <option value="">— Selecciona una comuna —</option>
          <option>Santiago</option>
          <option>Providencia</option>
          <option>Ñuñoa</option>
          <option>Las Condes</option>
          <option>Vitacura</option>
          <option>Maipú</option>
          <option>Puente Alto</option>
          <option>La Florida</option>
          <option>San Bernardo</option>
          <option>Peñalolén</option>
          <option>La Reina</option>
          <option>Quilicura</option>
        </select>
        <button id="mi-ubicacion-btn" class="button" type="button">Mi ubicación</button>
      </div>

      <p class="location-status" id="location-status" aria-live="polite">
        Mapa centrado en Santiago. Usa el buscador, el selector o “Mi ubicación”.
      </p>

      <!-- Contenedor del mapa de Google -->
      <div id="map" class="map-container" role="region" aria-label="Mapa Google de comunas"></div>
    </section>
    <!-- ===== /Mapa ===== -->
  </main>

  <footer class="site-footer" id="mensajes">
    <div class="footer-column">
      <h4>Citas Directas</h4>
      <p>Atención personalizada para empresas y flotas.</p>
    </div>
    <div class="footer-column">
      <h4>Servicios Adicionales</h4>
      <ul>
        <li>Mantenimiento Preventivo</li>
        <li>Inspecciones Técnicas</li>
        <li>Reemplazo de Partes</li>
      </ul>
    </div>
    <div class="footer-column">
      <h4>Contacto</h4>
      <p>+34 900 123 456</p>
      <p>soporte@autoserv.com</p>
    </div>
  </footer>

  <script src="../src/home-workshops.js" defer></script>
  <script src="../src/home-services.js" defer></script>

  <!-- Lógica de búsqueda de talleres y exploración de servicios -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.getElementById("search-input");
      const searchResults = document.getElementById("search-results");
      const visibilityTargets = document.querySelectorAll('[data-auth-visibility], [data-visible-for]');
      const unauthenticatedOnlyElements = document.querySelectorAll('[data-auth-visibility="unauthenticated"]');
      const authenticatedOnlyElements = document.querySelectorAll('[data-auth-visibility="authenticated"]');
      const mechanicOnlyElements = document.querySelectorAll('[data-visible-for="mecanico"]');
      const userOnlyElements = document.querySelectorAll('[data-visible-for="usuario"]');

      const visibilityState = {
        isAuthenticated: false,
        isMechanic: false,
      };

      const normalizeText = (value = "") => {
        if (typeof value !== "string") {
          return "";
        }

        return value
          .trim()
          .toLocaleLowerCase("es-CL")
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/ñ/g, "n");
      };

      const setElementVisibility = (el, shouldShow) => {
        if (shouldShow) {
          el.removeAttribute("hidden");
        } else {
          el.setAttribute("hidden", "");
        }
      };

      const applyVisibilityState = () => {
        const { isAuthenticated, isMechanic } = visibilityState;

        unauthenticatedOnlyElements.forEach((el) => {
          setElementVisibility(el, !isAuthenticated);
        });

        authenticatedOnlyElements.forEach((el) => {
          setElementVisibility(el, isAuthenticated);
        });

        mechanicOnlyElements.forEach((el) => {
          setElementVisibility(el, isAuthenticated && isMechanic);
        });

        userOnlyElements.forEach((el) => {
          setElementVisibility(el, isAuthenticated && !isMechanic);
        });

        visibilityTargets.forEach((el) => {
          if (el.dataset.authVisibility || el.dataset.visibleFor) {
            return;
          }
          setElementVisibility(el, true);
        });
      };

      const verifyMechanicProfile = async () => {
        try {
          const response = await fetch("/api/profile");
          if (!response.ok) {
            if (response.status === 401) {
              visibilityState.isAuthenticated = false;
              visibilityState.isMechanic = false;
              applyVisibilityState();
              return;
            }
            throw new Error("No se pudo obtener el perfil del usuario");
          }
          const profile = await response.json();
          visibilityState.isAuthenticated = true;
          visibilityState.isMechanic = profile?.accountType === "mecanico";
          applyVisibilityState();
          const role = visibilityState.isMechanic ? "mecanico" : "cliente";
          setNotifications(ROLE_NOTIFICATIONS[role] ?? []);
        } catch (e) {
          console.error(e);
          visibilityState.isAuthenticated = false;
          visibilityState.isMechanic = false;
          applyVisibilityState();
          clearNotifications();
        }
      };
      verifyMechanicProfile();

      applyVisibilityState();

      const SEARCH_LOADING_MESSAGE = '<p class="empty-results">Estamos cargando los talleres…</p>';
      const SEARCH_ERROR_MESSAGE = '<p class="empty-results">No se pudieron cargar los talleres. Intenta nuevamente más tarde.</p>';
      const SEARCH_EMPTY_MESSAGE = '<p class="empty-results">No encontramos talleres que coincidan con tu búsqueda.</p>';

      const notificationCenter = document.querySelector('[data-notification-center]');
      const notificationPanel = document.querySelector('[data-notification-panel]');
      const notificationToggle = document.querySelector('[data-notification-toggle]');
      const notificationList = document.querySelector('[data-notification-list]');
      const notificationEmpty = document.querySelector('[data-notification-empty]');
      const notificationCount = document.querySelector('[data-notification-count]');
      const notificationCloseButton = document.querySelector('[data-notification-close]');

      let workshops = [];
      let workshopsReady = false;
      let workshopsLoadError = false;
      let notifications = [];

      const ROLE_NOTIFICATIONS = {
        cliente: [
          {
            id: "client-registration",
            message: "¡Tu registro en Mechapp se completó correctamente!",
            type: "success",
          },
          {
            id: "client-request-sent",
            message: "Tu solicitud al taller fue enviada con éxito. En breve te contactarán.",
            type: "info",
          },
          {
            id: "client-appointment-accepted",
            message: "El taller Ruta 5 aceptó tu cita del 25 de junio.",
            type: "success",
          },
          {
            id: "client-appointment-rejected",
            message: "El taller Ciudad Motor no puede atender tu cita del 28 de junio.",
            type: "warning",
          },
        ],
        mecanico: [
          {
            id: "mechanic-registration",
            message: "Tu taller se registró correctamente en Mechapp.",
            type: "success",
          },
          {
            id: "mechanic-requests",
            message: "Tienes nuevas solicitudes esperando confirmación.",
            type: "info",
            action: {
              label: "Ir a solicitudes",
              href: "./perfil.html#solicitudes",
            },
          },
          {
            id: "mechanic-review",
            message: "Un cliente acaba de escribir una reseña sobre tu servicio.",
            type: "info",
            action: {
              label: "Ver reseñas",
              href: "./resenas-taller.html",
            },
          },
        ],
      };

      const renderNotifications = () => {
        if (!notificationList || !notificationEmpty || !notificationCount) {
          return;
        }

        notificationList.innerHTML = "";

        if (!notifications.length) {
          notificationEmpty.removeAttribute("hidden");
          notificationCount.setAttribute("hidden", "");
          notificationCount.textContent = "0";
          return;
        }

        notificationEmpty.setAttribute("hidden", "");
        notificationCount.textContent = notifications.length.toString();
        notificationCount.removeAttribute("hidden");

        const fragment = document.createDocumentFragment();
        notifications.forEach((item) => {
          const entry = document.createElement("li");
          entry.className = `notification-item notification-item--${item.type ?? "info"}`;

          const content = document.createElement("div");
          content.className = "notification-item__content";

          const text = document.createElement("p");
          text.textContent = item.message;
          content.appendChild(text);

          if (item.action?.href && item.action?.label) {
            const actionLink = document.createElement("a");
            actionLink.href = item.action.href;
            actionLink.textContent = item.action.label;
            actionLink.className = "notification-item__action";
            content.appendChild(actionLink);
          }

          entry.appendChild(content);

          const closeButton = document.createElement("button");
          closeButton.type = "button";
          closeButton.className = "notification-item__dismiss";
          closeButton.setAttribute("aria-label", "Descartar notificación");
          closeButton.dataset.notificationId = item.id;
          closeButton.textContent = "×";
          entry.appendChild(closeButton);

          fragment.appendChild(entry);
        });

        notificationList.appendChild(fragment);
      };

      const setNotifications = (items = []) => {
        notifications = Array.isArray(items) ? [...items] : [];
        renderNotifications();
      };

      const closeNotificationPanel = () => {
        if (!notificationPanel || !notificationToggle) {
          return;
        }
        notificationPanel.setAttribute("hidden", "");
        notificationToggle.setAttribute("aria-expanded", "false");
      };

      const openNotificationPanel = () => {
        if (!notificationPanel || !notificationToggle) {
          return;
        }
        notificationPanel.removeAttribute("hidden");
        notificationToggle.setAttribute("aria-expanded", "true");
      };

      const toggleNotificationPanel = () => {
        if (!notificationPanel || !notificationToggle) {
          return;
        }
        const isHidden = notificationPanel.hasAttribute("hidden");
        if (isHidden) {
          openNotificationPanel();
        } else {
          closeNotificationPanel();
        }
      };

      const clearNotifications = () => {
        notifications = [];
        renderNotifications();
        closeNotificationPanel();
      };

      notificationToggle?.addEventListener("click", () => {
        toggleNotificationPanel();
      });

      notificationCloseButton?.addEventListener("click", () => {
        closeNotificationPanel();
      });

      notificationList?.addEventListener("click", (event) => {
        const button = event.target.closest("[data-notification-id]");
        if (!button) {
          return;
        }
        const { notificationId } = button.dataset;
        if (!notificationId) {
          return;
        }
        notifications = notifications.filter((item) => item.id !== notificationId);
        renderNotifications();
      });

      document.addEventListener("click", (event) => {
        if (!notificationCenter || !notificationPanel || notificationPanel.hasAttribute("hidden")) {
          return;
        }
        if (notificationCenter.contains(event.target)) {
          return;
        }
        closeNotificationPanel();
      });

      function createWorkshopResult(workshop) {
        const article = document.createElement("article");
        article.className = "result-item";

        const type = document.createElement("div");
        type.className = "result-type";
        type.textContent = "Taller";
        type.setAttribute("aria-hidden", "true");
        article.appendChild(type);

        const content = document.createElement("div");
        content.className = "result-content";

        const title = document.createElement("h3");
        title.textContent = workshop.name;
        content.appendChild(title);

        const description = document.createElement("p");
        description.textContent = workshop.shortDescription || "Sin descripción disponible.";
        content.appendChild(description);

        article.appendChild(content);

        const link = document.createElement("a");
        link.className = "button ghost";
        link.href = `./perfil-taller.html?id=${encodeURIComponent(workshop.id)}`;
        link.textContent = "Ver más";
        link.setAttribute("aria-label", `Ver perfil del taller ${workshop.name}`);
        article.appendChild(link);

        return article;
      }

      function renderSearchResults(items) {
        if (!searchResults) {
          return;
        }

        if (!items.length) {
          searchResults.innerHTML = SEARCH_EMPTY_MESSAGE;
          return;
        }

        const fragment = document.createDocumentFragment();
        items.forEach((workshop) => {
          fragment.appendChild(createWorkshopResult(workshop));
        });
        searchResults.innerHTML = "";
        searchResults.appendChild(fragment);
      }

      async function loadWorkshops() {
        workshopsReady = false;
        workshopsLoadError = false;
        try {
          const response = await fetch("/api/workshops");
          if (!response.ok) {
            throw new Error("No se pudieron cargar los talleres");
          }
          const data = await response.json();
          workshops = Array.isArray(data?.workshops) ? data.workshops : [];
          workshopsReady = true;
          if (searchInput && searchInput.value.trim()) {
            searchInput.dispatchEvent(new Event("input"));
          }
        } catch (error) {
          console.error(error);
          workshops = [];
          workshopsReady = false;
          workshopsLoadError = true;
        }
      }

      searchInput?.addEventListener("input", (event) => {
        const term = normalizeText(event.target.value);
        if (!searchResults) {
          return;
        }

        if (!term) {
          searchResults.innerHTML = "";
          searchResults.setAttribute("hidden", "");
          return;
        }

        searchResults.removeAttribute("hidden");

        if (workshopsLoadError) {
          searchResults.innerHTML = SEARCH_ERROR_MESSAGE;
          return;
        }

        if (!workshopsReady) {
          searchResults.innerHTML = SEARCH_LOADING_MESSAGE;
          return;
        }

        const filtered = workshops.filter((workshop) => {
          const normalizedName = normalizeText(workshop?.name);
          if (!normalizedName) {
            return false;
          }

          return normalizedName.includes(term);
        });
        renderSearchResults(filtered);
      });

      loadWorkshops();
    });
  </script>

  <!-- Inicialización del mapa de Google y funcionalidad -->
  <script>
    // ==== Bloque JS de Google Maps ====
    window.initGMap = function () {
      const CL_REGION_SUFFIX = ", Región Metropolitana, Chile";
      const DEFAULT_CENTER = { lat: -33.4489, lng: -70.6693 };
      const DEFAULT_ZOOM = 12;
      const SEARCH_ZOOM = 13;
      const RADIUS_METERS = 4000;

      const $ = (id) => document.getElementById(id);
      const setStatus = (msg) => { const el = $("location-status"); if (el) el.textContent = msg; };

      // === ICONOS por URL (NO SVG path) ===
      const ICONS = {
        taller: {
          url: "assets/logo-oscuro.png",
          size: new google.maps.Size(55, 60), scaledSize: new google.maps.Size(55, 60),
          anchor: new google.maps.Point(14, 28)
        },
        vulca: {
          url: "assets/vulca-Photoroom.png",
          size: new google.maps.Size(55, 60), scaledSize: new google.maps.Size(55, 60),
          anchor: new google.maps.Point(14, 28)
        },
        user: {
          url: "/assets/markers/user-blue.png",
          size: new google.maps.Size(28, 28), scaledSize: new google.maps.Size(28, 28),
          anchor: new google.maps.Point(14, 28)
        },
        center: {
          url: "/assets/icono-central-mapa.jpg",
          size: new google.maps.Size(45, 55), scaledSize: new google.maps.Size(45, 55),
          anchor: new google.maps.Point(22, 34)
        }
      };

      let map, geocoder, autocomplete, userMarker = null, placeMarkers = [];
      let centerMarker = null; // marcador del centro de la comuna

      function clearPlaceMarkers() { placeMarkers.forEach(m => m.setMap(null)); placeMarkers = []; }
      function addPlaceMarker(pos, tipo, nombre) {
        const iconCfg = (tipo === "vulcanizacion") ? ICONS.vulca : ICONS.taller;
        const marker = new google.maps.Marker({
          position: pos, map, icon: iconCfg,
          title: nombre || (tipo === "vulcanizacion" ? "Vulcanización" : "Taller mecánico")
        });
        const iw = new google.maps.InfoWindow({
          content: `<strong>${nombre || (tipo === "vulcanizacion" ? "Vulcanización" : "Taller mecánico")}</strong><br><small>${tipo}</small>`
        });
        marker.addListener("click", () => iw.open({ anchor: marker, map }));
        placeMarkers.push(marker);
      }
      function samplePlaces(center) {
        const dx = (Math.random() - 0.5) * 0.04, dy = (Math.random() - 0.5) * 0.04;
        return [
          { lat: center.lat + dx, lng: center.lng + dy, tipo: "taller", nombre: "Taller Don Pepe" },
          { lat: center.lat + dy, lng: center.lng - dx, tipo: "vulcanizacion", nombre: "Vulcanización La Rueda" },
          { lat: center.lat - dx, lng: center.lng + dy, tipo: "taller", nombre: "Servicio Mecánico Andes" },
        ];
      }
      async function loadPlaces(center, comunaNombre) {
        clearPlaceMarkers();
        try {
          const res = await fetch("/data/talleres.json");
          const data = await res.json();

          // Filtra talleres por comuna
          const items = data.filter(p =>
            comunaNombre && p.comuna.toLowerCase() === comunaNombre.toLowerCase()
          );

          if (items.length > 0) {
            items.forEach(p => addPlaceMarker({ lat: p.lat, lng: p.lng }, p.tipo, p.nombre));
            setStatus(`Mostrando ${items.length} talleres/vulcanizaciones en ${comunaNombre}.`);
          } else {
            setStatus(`No hay talleres registrados para ${comunaNombre}.`);
          }

        } catch (err) {
          console.error("Error cargando talleres.json", err);
          setStatus("No se pudieron cargar los talleres de esta comuna.");
        }
      }

      function focus(center, comunaNombre) {
        map.setCenter(center);
        map.setZoom(SEARCH_ZOOM);

        // marcador del centro de la comuna
        if (!centerMarker) {
          centerMarker = new google.maps.Marker({
            position: center, map, icon: ICONS.center,
            title: comunaNombre ? `Centro: ${comunaNombre}` : "Centro de la zona"
          });
        } else {
          centerMarker.setPosition(center);
          centerMarker.setIcon(ICONS.center);
          centerMarker.setTitle(comunaNombre ? `Centro: ${comunaNombre}` : "Centro de la zona");
        }

        setStatus(`Mostrando comuna: ${comunaNombre || "—"}.`);
        loadPlaces(center, comunaNombre);
      }
      function geolocate() {
        if (!navigator.geolocation) { setStatus("Tu navegador no admite geolocalización."); return; }
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const center = { lat: pos.coords.latitude, lng: pos.coords.longitude };

          // marcador del usuario
          if (!userMarker) {
            userMarker = new google.maps.Marker({ position: center, map, icon: ICONS.user, title: "Estás aquí" });
          } else {
            userMarker.setPosition(center);
            userMarker.setIcon(ICONS.user);
          }

          try {
            const resp = await geocoder.geocode({ location: center });
            const commune = (resp.results[0]?.address_components || []).find(c => c.types.includes("locality"))?.long_name || "tu ubicación";
            focus(center, commune);
          } catch { focus(center, "tu ubicación"); }
        }, () => setStatus("No se pudo obtener tu ubicación."), { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 });
      }

      // === Inicializar mapa ===
      const el = document.getElementById("map");
      if (!el.style.height) el.style.height = "420px";

      map = new google.maps.Map(el, {
        center: DEFAULT_CENTER, zoom: DEFAULT_ZOOM,
        mapTypeControl: false, streetViewControl: false, fullscreenControl: true,
        gestureHandling: "greedy", scrollwheel: false
      });
      geocoder = new google.maps.Geocoder();

      // Autocomplete + eventos
      const input = document.getElementById("comuna-input");
      autocomplete = new google.maps.places.Autocomplete(input, {
        fields: ["geometry", "name", "address_components"],
        types: ["(regions)"], componentRestrictions: { country: "cl" }
      });
      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        const loc = place.geometry?.location; if (!loc) return;
        focus({ lat: loc.lat(), lng: loc.lng() }, place.name || "Comuna");
      });

      document.getElementById("comuna-btn").addEventListener("click", async () => {
        const q = input.value.trim(); if (!q) return;
        try {
          const resp = await geocoder.geocode({ address: q + CL_REGION_SUFFIX });
          const loc = resp.results[0]?.geometry?.location; if (!loc) return setStatus("No encontramos esa comuna.");
          const comuna = (resp.results[0].address_components || []).find(c => c.types.includes("locality"))?.long_name || q;
          focus({ lat: loc.lat(), lng: loc.lng() }, comuna);
        } catch { setStatus("No se pudo geocodificar esa comuna."); }
      });
      input.addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); document.getElementById("comuna-btn").click(); } });

      document.getElementById("comuna-select").addEventListener("change", async (e) => {
        const v = e.target.value; if (!v) return;
        try {
          const resp = await geocoder.geocode({ address: v + CL_REGION_SUFFIX });
          const loc = resp.results[0]?.geometry?.location; if (!loc) return;
          focus({ lat: loc.lat(), lng: loc.lng() }, v);
        } catch { setStatus("No se pudo cargar esa comuna."); }
      });

      document.getElementById("mi-ubicacion-btn").addEventListener("click", geolocate);

      // Carga inicial
      focus(DEFAULT_CENTER, "Santiago");
    };
  </script>

  <!-- SDK de Google Maps (una sola vez). Reemplaza la key si corresponde -->
  <script src="../src/chatbot.js" defer></script>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATF7l8QIpx6dlv2icl48TYG5N1PJVLdcw&callback=initGMap&libraries=places&v=weekly"
    async defer></script>
</body>

</html>
